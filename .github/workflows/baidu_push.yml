name: Hugo Build & Test Baidu Push

on:
  push:
    branches:
      - main   # æˆ– masterï¼Œæ ¹æ®ä½ çš„ä»“åº“åˆ†æ”¯ä¿®æ”¹
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ£€å‡ºä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ å®‰è£… Hugo
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.129.0'  # æ›¿æ¢ä¸ºä½ ä½¿ç”¨çš„ç‰ˆæœ¬

      # 3ï¸âƒ£ æ„å»ºç½‘ç«™
      - name: Build Hugo site
        run: hugo --minify

      # 4ï¸âƒ£ ä» sitemap.xml ç”Ÿæˆ URL åˆ—è¡¨
      - name: Generate URLs list from sitemap
        run: |
          # ä» public/sitemap.xml æå–æ‰€æœ‰ <loc> æ ‡ç­¾å†…å®¹
          grep -oP '(?<=<loc>).*?(?=</loc>)' public/sitemap.xml > urls.txt
          echo "âœ… ç”Ÿæˆ URL åˆ—è¡¨æˆåŠŸï¼Œå…± $(wc -l < urls.txt) æ¡"
          echo "----------------------------------"
          head -n 10 urls.txt
          echo "(ä»¥ä¸Šä¸ºå‰ 10 æ¡)"
          echo "----------------------------------"

      # 5ï¸âƒ£ æ£€æŸ¥ç™¾åº¦æ¨é€æ¥å£é…é¢ + æµ‹è¯•æ¨é€ 1 æ¡ URL
      - name: Check Baidu quota and test push
        env:
          BAIDU_TOKEN: ${{ secrets.BAIDU_TOKEN }}
          SITE_URL: https://www.haoshuang.org
        run: |
          echo "å¼€å§‹æµ‹è¯•ç™¾åº¦æ¨é€æ¥å£..."
          echo "----------------------------------"
          
          head -n 8 urls.txt > test_url.txt
          echo "æµ‹è¯•æ¨é€çš„ URLï¼š"
          cat test_url.txt
          echo "----------------------------------"

          RESPONSE=$(curl -s -H 'Content-Type:text/plain' --data-binary @test_url.txt \
          "http://data.zz.baidu.com/urls?site=${SITE_URL}&token=${BAIDU_TOKEN}")

          echo "ç™¾åº¦è¿”å›ç»“æœï¼š"
          echo "$RESPONSE"
          echo "----------------------------------"

          if echo "$RESPONSE" | grep -q '"success"'; then
            SUCCESS=$(echo "$RESPONSE" | grep -oP '(?<="success":)\d+')
            REMAIN=$(echo "$RESPONSE" | grep -oP '(?<="remain":)\d+')
            echo "âœ… æˆåŠŸæ¨é€ï¼š$SUCCESS æ¡"
            echo "ğŸ’¾ ä»Šæ—¥å‰©ä½™é¢åº¦ï¼š$REMAIN æ¡"
          elif echo "$RESPONSE" | grep -q '"error"'; then
            ERROR_CODE=$(echo "$RESPONSE" | grep -oP '(?<="error":)\d+')
            MESSAGE=$(echo "$RESPONSE" | grep -oP '(?<="message":")[^"]+')
            echo "âŒ æ¨é€å¤±è´¥ï¼Œé”™è¯¯ä»£ç ï¼š$ERROR_CODE"
            echo "åŸå› ï¼š$MESSAGE"
          else
            echo "âš ï¸ æœªè¯†åˆ«çš„è¿”å›æ ¼å¼ï¼š"
            echo "$RESPONSE"
          fi

      # 6ï¸âƒ£ å®Œæˆæç¤º
      - name: Done
        run: echo "âœ… Hugo æ„å»º + ç™¾åº¦æ¨é€æµ‹è¯• å®Œæˆ"